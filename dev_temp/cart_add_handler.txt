@router.callback_query(F.data.startswith("cart_add:"))
async def add_to_cart(callback: CallbackQuery):
    """–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)"""
    try:
        parts = callback.data.split(":")
        product_id = int(parts[1])
        quantity = int(parts[2])
        category_id = int(parts[3])

        if quantity <= 0:
            await callback.answer("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", show_alert=True)
            return

        user = await cart_service.get_or_create_user(callback.from_user.id)
        result = await cart_service.add_to_cart(user.id, product_id, quantity)

        if result["success"]:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            reset_temp_quantity(callback.from_user.id, product_id)

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤ –∫–æ—Ä–∑–∏–Ω–µ
            product = await catalog_service.get_product(product_id)

            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ
            async with get_session() as session:
                stmt = select(CartItem).where(
                    CartItem.user_id == user.id,
                    CartItem.product_id == product_id
                )
                result2 = await session.execute(stmt)
                cart_item = result2.scalar_one_or_none()
                current_in_cart = cart_item.quantity if cart_item else 0

            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ/–ø–æ–¥–ø–∏—Å—å
            description = product.get("description", "") or ""
            caption = (
                f"ü¶¥ {product['name']}\n\n"
                f"{description}\n\n"
            )
            
            # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞
            if product.get('unit_type', 'grams') == 'grams':
                price_text = f"üí∞ –¶–µ–Ω–∞: {product['price']} RSD/100–≥\n"
                stock_text = f"üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {product['stock_grams']}–≥\n"
                cart_text = f"‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ: {current_in_cart}–≥\n"
            else:
                price_text = f"üí∞ –¶–µ–Ω–∞: {product['price']} RSD/—à—Ç\n"
                stock_text = f"üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {product['stock_grams']}—à—Ç\n"
                cart_text = f"‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ: {current_in_cart}—à—Ç\n"
            
            caption += price_text
            caption += stock_text
            caption += cart_text
            caption += f"\n–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!"

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–±—Ä–æ—à–µ–Ω–Ω—ã–º —Å—á–µ—Ç—á–∏–∫–æ–º
            keyboard = product_card_keyboard(
                product_id, 
                category_id, 
                0, 
                product.get("unit_type", "grams"), 
                product.get("measurement_step", 100)
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            try:
                if callback.message.photo:
                    await callback.message.edit_caption(
                        caption=caption,
                        reply_markup=keyboard
                    )
                else:
                    await callback.message.edit_text(
                        text=caption,
                        reply_markup=keyboard
                    )
            except TelegramBadRequest:
                await send_product_with_image(callback, product, caption, keyboard)
            
            unit_suffix = "–≥" if product.get("unit_type", "grams") == "grams" else "—à—Ç"
            await callback.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É: {quantity}{unit_suffix}")
        else:
            await callback.answer(result["error"], show_alert=True)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è", show_alert=True)

# ========== –ö–û–†–ó–ò–ù–ê ==========

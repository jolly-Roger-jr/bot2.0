"""

–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è Barkery Shop

"""

import logging

import asyncio

from aiogram import Router, F

from aiogram.types import Message, CallbackQuery

from aiogram.filters import Command

from aiogram.fsm.context import FSMContext

from aiogram.fsm.state import State, StatesGroup

from aiogram.exceptions import TelegramBadRequest



from keyboards import (

    main_menu_keyboard,

    categories_keyboard,

    products_keyboard,

    product_card_keyboard,

    cart_keyboard,

    order_confirmation_keyboard

)

from services import cart_service, catalog_service, user_service

from database import get_session, Product, CartItem, User

from sqlalchemy import select



logger = logging.getLogger(__name__)

router = Router()



# –•—Ä–∞–Ω–∏–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–æ–≤–∞—Ä–∞

temp_quantities = {}



# ========== –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –ó–ê–ö–ê–ó–ê ==========



class OrderForm(StatesGroup):

    waiting_pet_name = State()

    waiting_telegram_login = State()

    waiting_address = State()



# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========



def get_temp_quantity_key(user_id: int, product_id: int) -> str:

    """–ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞"""

    return f"{user_id}_{product_id}"



def update_temp_quantity(user_id: int, product_id: int, delta: int) -> int:

    """–û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏"""

    key = get_temp_quantity_key(user_id, product_id)

    current = temp_quantities.get(key, 0)

    new_quantity = current + delta

    

    # –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0

    if new_quantity < 0:

        new_quantity = 0

    

    temp_quantities[key] = new_quantity

    return new_quantity



def reset_temp_quantity(user_id: int, product_id: int):

    """–°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"""

    key = get_temp_quantity_key(user_id, product_id)

    temp_quantities[key] = 0



# ========== –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ==========



@router.message(Command("start"))

async def cmd_start(message: Message):

    """–ö–æ–º–∞–Ω–¥–∞ /start"""

    try:

        user = await cart_service.get_or_create_user(

            telegram_id=message.from_user.id,

            username=message.from_user.username,

            full_name=message.from_user.full_name

        )

        

        welcome_text = (

            "üêï –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Barkery Shop!\n\n"

            "–ú–∞–≥–∞–∑–∏–Ω –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã—Ö —Å–æ–±–∞—á—å–∏—Ö –ª–∞–∫–æ–º—Å—Ç–≤ ü¶¥\n\n"

            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:"

        )

        

        await message.answer(

            welcome_text,

            reply_markup=main_menu_keyboard()

        )

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –≤ /start: {e}")

        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞")



@router.message(Command("help"))

async def cmd_help(message: Message):

    """–ö–æ–º–∞–Ω–¥–∞ /help"""

    help_text = (

        "üêæ –ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É Barkery Shop\n\n"

        "üì¶ –ö–∞—Ç–∞–ª–æ–≥ - –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏\n"

        "üõí –ö–æ—Ä–∑–∏–Ω–∞ - –≤–∞—à–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã\n"

        "üë§ –ü—Ä–æ—Ñ–∏–ª—å - –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ\n\n"

        "üì± –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑:\n"

        "1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ\n"

        "2. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É\n"

        "3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É\n"

        "4. –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑\n\n"

        "üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: @support"

    )

    

    await message.answer(help_text)



# ========== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ==========



@router.callback_query(F.data == "main_menu")

async def main_menu_handler(callback: CallbackQuery):

    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""

    await callback.message.edit_text(

        "üêï –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",

        reply_markup=main_menu_keyboard()

    )

    await callback.answer()



@router.callback_query(F.data == "catalog")

async def show_categories(callback: CallbackQuery):

    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""

    try:

        categories = await catalog_service.get_categories()

        

        if not categories:

            await callback.message.edit_text("üì¶ –ö–∞—Ç–∞–ª–æ–≥\n\n–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.")

            return

        

        await callback.message.edit_text(

            "üì¶ –ö–∞—Ç–∞–ª–æ–≥\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",

            reply_markup=categories_keyboard(categories)

        )

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π", show_alert=True)



@router.callback_query(F.data.startswith("category:"))

async def show_products(callback: CallbackQuery):

    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""

    try:

        category_id = int(callback.data.split(":")[1])

        products = await catalog_service.get_products_by_category(category_id)

        

        if not products:

            await callback.message.edit_text(

                "üì≠ –¢–æ–≤–∞—Ä—ã\n\n–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤."

            )

            return

        

        await callback.message.edit_text(

            "üì¶ –¢–æ–≤–∞—Ä—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:",

            reply_markup=products_keyboard(products, category_id)

        )

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤", show_alert=True)



@router.callback_query(F.data.startswith("product:"))

async def show_product(callback: CallbackQuery):

    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞"""

    try:

        parts = callback.data.split(":")

        product_id = int(parts[1])

        category_id = int(parts[2])



        product = await catalog_service.get_product(product_id)

        if not product:

            await callback.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)

            return



        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ

        user = await cart_service.get_or_create_user(callback.from_user.id)

        async with get_session() as session:

            stmt = select(CartItem).where(

                CartItem.user_id == user.id,

                CartItem.product_id == product_id

            )

            result = await session.execute(stmt)

            cart_item = result.scalar_one_or_none()

            current_in_cart = cart_item.quantity if cart_item else 0



        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ)

        temp_key = get_temp_quantity_key(callback.from_user.id, product_id)

        temp_qty = temp_quantities.get(temp_key, 0)



        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç

        description = product.get("description", "") or ""

        text = (

            f"ü¶¥ {product['name']}\n\n"

            f"{description}\n\n"

            f"üí∞ –¶–µ–Ω–∞: {product['price']} RSD/100–≥\n"

            f"üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {product['stock_grams']}–≥\n"

            f"üõí –í –∫–æ—Ä–∑–∏–Ω–µ: {current_in_cart}–≥\n\n"

            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:"

        )

        

        keyboard = product_card_keyboard(product_id, category_id, temp_qty, product.get("unit_type", "grams"), product.get("measurement_step", 100))
        await callback.message.edit_text(text, reply_markup=keyboard)

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Ç–æ–≤–∞—Ä–∞: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞", show_alert=True)



@router.callback_query(F.data.startswith("back_to_products:"))

async def back_to_products(callback: CallbackQuery):

    """–ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""

    category_id = int(callback.data.split(":")[1])

    await show_products(callback)



# ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–û–ú ==========



@router.callback_query(F.data.startswith("qty_"))

async def handle_quantity(callback: CallbackQuery):

    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞"""

    try:

        parts = callback.data.split(":")

        action = parts[0]

        product_id = int(parts[1])

        category_id = int(parts[2])

        

        if action == "qty_info":

            await callback.answer("üìä –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ")

            return

        

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ

        product = await catalog_service.get_product(product_id)

        if not product:

            await callback.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)

            return

        

        user = await cart_service.get_or_create_user(callback.from_user.id)

        

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–ª—å—Ç—É

        delta = -100 if action == "qty_dec" else 100

        

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ

        async with get_session() as session:

            stmt = select(CartItem).where(

                CartItem.user_id == user.id,

                CartItem.product_id == product_id

            )

            result = await session.execute(stmt)

            cart_item = result.scalar_one_or_none()

            current_in_cart = cart_item.quantity if cart_item else 0

        

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

        temp_key = get_temp_quantity_key(callback.from_user.id, product_id)

        current_temp = temp_quantities.get(temp_key, 0)

        

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≤ –∫–æ—Ä–∑–∏–Ω–µ + –Ω–æ–≤–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ)

        new_temp = current_temp + delta

        

        # –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0

        if new_temp < 0:

            await callback.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0")

            return

        

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

        total_qty = current_in_cart + new_temp

        if total_qty > product['stock_grams']:

            max_can_add = product['stock_grams'] - current_in_cart

            new_temp = max_can_add

            await callback.answer(f"‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: {max_can_add}–≥", show_alert=True)

            if max_can_add <= 0:

                return

        

        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

        temp_quantities[temp_key] = new_temp

        

        # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

        description = product.get("description", "") or ""

        text = (

            f"ü¶¥ {product['name']}\n\n"

            f"{description}\n\n"

            f"üí∞ –¶–µ–Ω–∞: {product['price']} RSD/100–≥\n"

            f"üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {product['stock_grams']}–≥\n"

            f"üõí –í –∫–æ—Ä–∑–∏–Ω–µ: {current_in_cart}–≥\n\n"

            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:"

        )

        

        keyboard = product_card_keyboard(product_id, category_id, temp_qty, product.get("unit_type", "grams"), product.get("measurement_step", 100))
        await callback.message.edit_text(text, reply_markup=keyboard)

        

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ

        await callback.answer(f"–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {new_temp}–≥")

            

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞", show_alert=True)



@router.callback_query(F.data.startswith("cart_add:"))

async def add_to_cart(callback: CallbackQuery):
    """–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)"""

    try:
        parts = callback.data.split(":")
        product_id = int(parts[1])
        quantity = int(parts[2])
        category_id = int(parts[3])

        if quantity <= 0:
            await callback.answer("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", show_alert=True)
            return

        user = await cart_service.get_or_create_user(callback.from_user.id)
        result = await cart_service.add_to_cart(user.id, product_id, quantity)

        if result["success"]:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            reset_temp_quantity(callback.from_user.id, product_id)

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤ –∫–æ—Ä–∑–∏–Ω–µ
            product = await catalog_service.get_product(product_id)

            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ
            async with get_session() as session:
                stmt = select(CartItem).where(
                    CartItem.user_id == user.id,
                    CartItem.product_id == product_id
                )
                result2 = await session.execute(stmt)
                cart_item = result2.scalar_one_or_none()
                current_in_cart = cart_item.quantity if cart_item else 0

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
            description = product.get("description", "") or ""
            text = (
                f"ü¶¥ {product['name']}\n\n"
                f"{description}\n\n"
                f"üí∞ –¶–µ–Ω–∞: {product['price']} RSD/100–≥\n"
                f"üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {product['stock_grams']}–≥\n"
                f"‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ: {current_in_cart}–≥\n\n"
                f"–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!"
            )

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–±—Ä–æ—à–µ–Ω–Ω—ã–º —Å—á–µ—Ç—á–∏–∫–æ–º
            keyboard = product_card_keyboard(product_id, category_id, 0, product.get("unit_type", "grams"), product.get("measurement_step", 100))
            await callback.message.edit_text(text, reply_markup=keyboard)
            await callback.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É: {quantity}–≥")
        else:
            await callback.answer(result["error"], show_alert=True)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è", show_alert=True)


    logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É: {e}")

    await callback.answer("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è", show_alert=True)



    # ========== –ö–û–†–ó–ò–ù–ê ==========



@router.callback_query(F.data == "cart")

async def show_cart(callback: CallbackQuery):

    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É"""

    try:

        user = await cart_service.get_or_create_user(callback.from_user.id)

        cart_data = await cart_service.get_cart(user.id)

        

        if not cart_data["items"]:

            await callback.message.edit_text(

                "üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞\n\n–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞!"

            )

            return

        

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤

        items_text = "\n".join([

            f"‚Ä¢ {item['product_name']}: {item['quantity_grams']}–≥ - {item['total_price']:.0f} RSD"

            for item in cart_data["items"]

        ])

        

        cart_text = (

            f"üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞\n\n"

            f"{items_text}\n\n"

            f"üì¶ –¢–æ–≤–∞—Ä–æ–≤: {cart_data['total_items']} —à—Ç.\n"

            f"üí∞ –ò—Ç–æ–≥–æ: {cart_data['total_price']:.0f} RSD"

        )

        

        await callback.message.edit_text(

            cart_text,

            reply_markup=cart_keyboard(cart_data["items"], cart_data["total_price"])

        )

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–æ—Ä–∑–∏–Ω—ã: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã", show_alert=True)



@router.callback_query(F.data == "cart_clear")

async def clear_cart(callback: CallbackQuery):

    """–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É"""

    try:

        user = await cart_service.get_or_create_user(callback.from_user.id)

        result = await cart_service.clear_cart(user.id)

        

        if result["success"]:

            # –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            user_prefix = f"{callback.from_user.id}_"

            keys_to_remove = [k for k in temp_quantities.keys() if k.startswith(user_prefix)]

            for key in keys_to_remove:


                del temp_quantities[key]



            del temp_quantities[key]

            

            await callback.message.edit_text(

                f"‚úÖ {result['message']}\n\n–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞."

            )

        await callback.answer(result["message"])

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏", show_alert=True)



# ========== –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–ö–ê–ó–ê ==========



@router.callback_query(F.data == "order_create")

async def start_order(callback: CallbackQuery, state: FSMContext):

    """–ù–∞—á–∞—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""

    try:

        user = await cart_service.get_or_create_user(callback.from_user.id)

        cart_data = await cart_service.get_cart(user.id)

        

        if not cart_data["items"]:

            await callback.answer("üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!", show_alert=True)

            return

        

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–æ—Ä–∑–∏–Ω–µ

        await state.update_data(

            user_id=user.id,

            cart_items=cart_data["items"],

            total_amount=cart_data["total_price"]

        )

        

        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö

        await state.set_state(OrderForm.waiting_pet_name)

        

        items_text = "\n".join([

            f"‚Ä¢ {item['product_name']}: {item['quantity_grams']}–≥ - {item['total_price']:.0f} RSD"

            for item in cart_data["items"]

        ])

        

        order_text = (

            "üõéÔ∏è –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞\n\n"

            f"–í–∞—à –∑–∞–∫–∞–∑:\n{items_text}\n\n"

            f"–ò—Ç–æ–≥–æ: {cart_data['total_price']:.0f} RSD\n\n"

            "–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.\n\n"

            "üêï –®–∞–≥ 1 –∏–∑ 3: –ö–∞–∫ –∑–æ–≤—É—Ç –≤–∞—à–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞?"

        )

        

        await callback.message.edit_text(order_text)

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–∫–∞–∑–∞: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞", show_alert=True)



@router.message(OrderForm.waiting_pet_name)

async def process_pet_name(message: Message, state: FSMContext):

    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–Ω–∏ –ø–∏—Ç–æ–º—Ü–∞"""

    pet_name = message.text.strip()

    

    if len(pet_name) < 2:

        await message.answer("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∏—Ç–æ–º—Ü–∞:")

        return

    

    await state.update_data(pet_name=pet_name)

    await state.set_state(OrderForm.waiting_telegram_login)

    

    await message.answer(

        f"‚úÖ –ò–º—è –ø–∏—Ç–æ–º—Ü–∞ –ø—Ä–∏–Ω—è—Ç–æ: {pet_name}\n\n"

        "üì± –®–∞–≥ 2 –∏–∑ 3: –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram login (–±–µ–∑ @):\n"

        "–ù–∞–ø—Ä–∏–º–µ—Ä: ivanov_ivan"

    )



@router.message(OrderForm.waiting_telegram_login)

async def process_telegram_login(message: Message, state: FSMContext):

    """–û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram –ª–æ–≥–∏–Ω–∞"""

    telegram_login = message.text.strip().replace("@", "")

    

    if len(telegram_login) < 3:

        await message.answer("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π login. –í–≤–µ–¥–∏—Ç–µ Telegram login:")

        return

    

    await state.update_data(telegram_login=telegram_login)

    await state.set_state(OrderForm.waiting_address)

    

    await message.answer(

        f"‚úÖ Telegram login –ø—Ä–∏–Ω—è—Ç: @{telegram_login}\n\n"

        "üìç –®–∞–≥ 3 –∏–∑ 3: –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:\n"

        "–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞, —Ä–∞–π–æ–Ω, –≥–æ—Ä–æ–¥\n\n"

        "–ü—Ä–∏–º–µ—Ä: —É–ª. –ö–Ω–µ–∑ –ú–∏—Ö–∞–∏–ª–æ–≤–∞ 15, –∫–≤. 23, –°—Ç–∞—Ä–∏-–ì—Ä–∞–¥, –ë–µ–ª–≥—Ä–∞–¥"

    )



@router.message(OrderForm.waiting_address)

async def process_address(message: Message, state: FSMContext):

    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–¥—Ä–µ—Å–∞"""

    address = message.text.strip()

    

    if len(address) < 10:

        await message.answer("‚ùå –ê–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å:")

        return

    

    data = await state.get_data()

    

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

    items_text = "\n".join([

        f"‚Ä¢ {item['product_name']}: {item['quantity_grams']}–≥ - {item['total_price']:.0f} RSD"

        for item in data["cart_items"]

    ])

    

    confirmation_text = (

        "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞\n\n"

        f"üêï –ü–∏—Ç–æ–º–µ—Ü: {data['pet_name']}\n"

        f"üì± Telegram: @{data['telegram_login']}\n"

        f"üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: {address}\n\n"

        f"üìã –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:\n{items_text}\n\n"

        f"üí∞ –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: {data['total_amount']:.0f} RSD\n\n"

        "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑:"

    )

    

    await message.answer(

        confirmation_text,

        reply_markup=order_confirmation_keyboard()

    )

    

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å

    await state.update_data(address=address)



@router.callback_query(F.data == "order_confirm")

async def confirm_order(callback: CallbackQuery, state: FSMContext):

    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""

    try:

        data = await state.get_data()

        

        async with get_session() as session:

            # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑

            from database import Order, OrderItem

            import datetime

            

            order = Order(

                user_id=data["user_id"],

                customer_name=data["pet_name"],

                phone=f"@{data['telegram_login']}",

                address=data['address'],

                total_amount=data['total_amount'],

                status="pending",

                created_at=datetime.datetime.now()

            )

            

            session.add(order)

            await session.commit()

            await session.refresh(order)

            

            # –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–∞

            for item_data in data['cart_items']:

                order_item = OrderItem(

                    order_id=order.id,

                    product_id=item_data['product_id'],

                    product_name=item_data['product_name'],

                    price_per_100g=item_data['price_per_100g'],

                    quantity=item_data['quantity_grams']

                )

                session.add(order_item)

            

            await session.commit()

            

            # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É

            await cart_service.clear_cart(data["user_id"])

            

            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            user_prefix = f"{data['user_id']}_"

            keys_to_remove = [k for k in temp_quantities.keys() if k.startswith(user_prefix)]

            for key in keys_to_remove:


                del temp_quantities[key]



            del temp_quantities[key]

            

            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É

            try:

                from notifications import notify_admin

                await notify_admin(callback.bot, data, order.id)

            except Exception as admin_error:

                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {admin_error}")

            

            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ

            await state.clear()

            

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö

            success_text = (

                "üéâ *–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!*\n\n"

                f"üì¶ *–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:* #{order.id}\n"

                f"üí∞ *–°—É–º–º–∞:* {order.total_amount:.0f} RSD\n\n"

                "üìû *–ß—Ç–æ –¥–∞–ª—å—à–µ?*\n"

                "1. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞\n"

                "2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –≤–∞—à–∏ –ª–∞–∫–æ–º—Å—Ç–≤–∞\n"

                "3. –î–æ—Å—Ç–∞–≤–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤\n\n"

                "*–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!* üê∂"

            )

            

            await callback.message.edit_text(

                success_text,

                parse_mode="Markdown",

                reply_markup=main_menu_keyboard()

            )

            

            await callback.answer()

            

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞", show_alert=True)



# ========== –ü–†–û–§–ò–õ–¨ ==========



@router.callback_query(F.data == "profile")

async def show_profile(callback: CallbackQuery):

    """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"""

    try:

        user = await cart_service.get_or_create_user(callback.from_user.id)

        

        profile_text = (

            f"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å\n\n"

            f"üêï –ü–∏—Ç–æ–º–µ—Ü: {user.full_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n"

            f"üì± Telegram: @{user.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"

            f"üÜî ID: {user.id}\n"

            f"üìÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {user.created_at.strftime('%d.%m.%Y')}\n\n"

            "–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –æ—Ñ–æ—Ä–º–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑."

        )

        

        await callback.message.edit_text(profile_text, reply_markup=main_menu_keyboard())

        

    except Exception as e:

        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø—Ä–æ—Ñ–∏–ª—è: {e}")

        await callback.answer("‚ùå –û—à–∏–±–∫–∞", show_alert=True)



# ========== –ü–û–ú–û–©–¨ ==========



@router.callback_query(F.data == "help")

async def handle_help(callback: CallbackQuery):

    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å"""

    help_text = (

        "üêæ –ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É Barkery Shop\n\n"

        "üì¶ –ö–∞—Ç–∞–ª–æ–≥ - –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n"

        "üõí –ö–æ—Ä–∑–∏–Ω–∞ - –≤–∞—à–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã\n"

        "üë§ –ü—Ä–æ—Ñ–∏–ª—å - –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ\n\n"

        "üì± –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑:\n"

        "1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ\n"

        "2. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É\n"

        "3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É\n"

        "4. –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑\n\n"

        "üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞: @support"

    )

    

    from keyboards import help_keyboard

    await callback.message.edit_text(

        help_text,

        reply_markup=help_keyboard()

    )

    await callback.answer()



# ========== –û–ë–†–ê–ë–û–¢–ö–ê –ù–ï–ò–ó–í–ï–°–¢–ù–´–• –ö–û–õ–ë–≠–ö–û–í ==========



@router.callback_query()

async def handle_unknown_callback(callback: CallbackQuery):

    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback-–∑–∞–ø—Ä–æ—Å–æ–≤"""

    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–ª–±—ç–∫–∏ (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –∞–¥–º–∏–Ω—Å–∫–æ–º —Ä–æ—É—Ç–µ—Ä–µ)

    if callback.data.startswith("admin_"):

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–ª–±—ç–∫–∏

        return

    

    logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–ª–±—ç–∫: {callback.data}")

    await callback.answer("‚ö†Ô∏è –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç", show_alert=True)

    await callback.message.edit_text(

        "üêï –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",

        reply_markup=main_menu_keyboard()

    )

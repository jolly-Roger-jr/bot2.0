--- handlers_original.py	2026-02-04 03:00:00
+++ handlers_fixed.py	2026-02-04 03:01:00
@@ -873,19 +873,22 @@
         }
 
         # Очищаем None значения
         user_update_data = {k: v for k, v in user_update_data.items() if v is not None}
 
+        # Получаем user_id
+        user = await cart_service.get_or_create_user(callback.from_user.id)
+        user_id = user.id
+
         # Обновляем пользователя
-        await user_service.update_user_info(data["user_id"], **user_update_data)
+        await user_service.update_user_info(user_id, **user_update_data)
 
         async with get_session() as session:
             # Создаем заказ
             from database import Order, OrderItem
             import datetime
 
             order = Order(
-                user_id=data["user_id"],
+                user_id=user_id,
                 customer_name=data["pet_name"],
                 phone=f"@{data['telegram_login']}",
                 address=data['address'],
@@ -913,11 +916,16 @@
 
                     # УВЕДОМЛЯЕМ ДРУГИХ ПОЛЬЗОВАТЕЛЕЙ
                     # Товар скрыт - уведомляем других пользователей
-                    notified = await check_and_notify_out_of_stock(
-                        callback.bot,
-                        item_data['product_id'],
-                        item_data['product_name'],
-                        ordering_user_id=data["user_id"]
-                    )
-                    if notified > 0:
-                        logger.info(f"Уведомлено {notified} пользователей о закончившемся товаре {item_data['product_name']}")
+                    try:
+                        notified = await check_and_notify_out_of_stock(
+                            callback.bot,
+                            item_data['product_id'],
+                            item_data['product_name'],
+                            ordering_user_id=user_id
+                        )
+                        if notified > 0:
+                            logger.info(f"Уведомлено {notified} пользователей о закончившемся товаре {item_data['product_name']}")
+                    except Exception as notify_error:
+                        logger.error(f"Ошибка уведомления (пропускаем): {notify_error}")
+            
+            await session.commit()

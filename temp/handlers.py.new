import logging
import asyncio
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.exceptions import TelegramBadRequest
import datetime

from keyboards import (
    main_menu_keyboard,
    categories_keyboard,
    products_keyboard,
    product_card_keyboard,
    cart_keyboard,
    order_confirmation_keyboard
)
from services import cart_service, catalog_service, user_service, update_product_stock_and_availability
from admin import check_and_notify_out_of_stock
from database import get_session, Product, CartItem, User, Order, OrderItem
from sqlalchemy import select

logger = logging.getLogger(__name__)
router = Router()

# ... [–≤—Å—è –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–∞–π–ª–∞ –¥–æ confirm_order –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ...

@router.callback_query(F.data == "order_confirm")
async def confirm_order(callback: CallbackQuery, state: FSMContext):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""
    try:
        data = await state.get_data()
        
        # –ü–æ–ª—É—á–∞–µ–º user_id
        user = await cart_service.get_or_create_user(callback.from_user.id)
        user_id = user.id

        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –ë–î
        user_update_data = {
            "pet_name": data.get("pet_name"),
            "telegram_login": data.get("telegram_login"),  # –ò–°–ü–†–ê–í–õ–ï–ù–û: –±—ã–ª–æ telegram_username
            "address": data.get("address")  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        }

        # –û—á–∏—â–∞–µ–º None –∑–Ω–∞—á–µ–Ω–∏—è
        user_update_data = {k: v for k, v in user_update_data.items() if v is not None}

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await user_service.update_user_info(user_id, **user_update_data)  # –ò–°–ü–†–ê–í–õ–ï–ù–û: user_id –≤–º–µ—Å—Ç–æ data["user_id"]

        async with get_session() as session:
            # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
            order = Order(
                user_id=user_id,  # –ò–°–ü–†–ê–í–õ–ï–ù–û: user_id –≤–º–µ—Å—Ç–æ data["user_id"]
                customer_name=data["pet_name"],
                phone=f"@{data['telegram_login']}",
                address=data['address'],
                total_amount=data['total_amount'],
                status="pending",
                created_at=datetime.datetime.now()
            )
            
            session.add(order)
            await session.commit()
            await session.refresh(order)
            
            # –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–∞
            for item_data in data['cart_items']:
                order_item = OrderItem(
                    order_id=order.id,
                    product_id=item_data['product_id'],
                    product_name=item_data['product_name'],
                    price_per_100g=item_data['price_per_100g'],
                    quantity=item_data['quantity']
                )
                session.add(order_item)
                # –í–´–ß–ò–¢–ê–ï–ú –û–°–¢–ê–¢–ö–ò –ü–û–°–õ–ï –ó–ê–ö–ê–ó–ê
                stock_result = await update_product_stock_and_availability(
                    item_data['product_id'],
                    item_data['quantity']
                )

                if stock_result["success"] and stock_result.get("hidden"):
                    logger.info(f"–¢–æ–≤–∞—Ä {stock_result['product_name']} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞")

                    # –£–í–ï–î–û–ú–õ–Ø–ï–ú –î–†–£–ì–ò–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
                    # –¢–æ–≤–∞—Ä —Å–∫—Ä—ã—Ç - —É–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    try:
                        notified = await check_and_notify_out_of_stock(
                            callback.bot,
                            item_data['product_id'],
                            item_data['product_name'],
                            ordering_user_id=user_id
                        )
                        if notified > 0:
                            logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–æ {notified} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –∑–∞–∫–æ–Ω—á–∏–≤—à–µ–º—Å—è —Ç–æ–≤–∞—Ä–µ {item_data['product_name']}")
                    except Exception as notify_error:
                        logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º): {notify_error}")
            
            await session.commit()
            
            # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            await cart_service.clear_cart(user_id)
            
            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_prefix = f"{user_id}_"
            import sys
            if 'temp_quantities' in sys.modules[__name__].__dict__:
                keys_to_remove = [k for k in temp_quantities.keys() if k.startswith(user_prefix)]
                for key in keys_to_remove:
                    del temp_quantities[key]
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
            try:
                from notifications import notify_admin
                await notify_admin(callback.bot, data, order.id)
            except Exception as admin_error:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {admin_error}")
            
            # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            await state.clear()
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            success_text = (
                "üéâ *–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!*\n\n"
                f"üì¶ *–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:* #{order.id}\n"
                f"üí∞ *–°—É–º–º–∞:* {order.total_amount:.0f} RSD\n\n"
                "üìû *–ß—Ç–æ –¥–∞–ª—å—à–µ?*\n"
                "1. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞\n"
                "2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –≤–∞—à–∏ –ª–∞–∫–æ–º—Å—Ç–≤–∞\n"
                "3. –°–æ–≥–ª–∞—Å—É–µ–º —É—Å–ª–æ–≤–∏—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ –∏–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏\n\n"
                "*–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!* üê∂"
            )
            
            await safe_edit_message(
                callback,
                success_text,
                reply_markup=main_menu_keyboard()
            )
            
            await callback.answer()
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: {e}")
        await callback.answer("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞", show_alert=True)

# ... [–æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–∞–π–ª–∞] ...
